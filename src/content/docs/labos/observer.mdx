---
title: Odoo - Observateur-Observé
description: Docs intro
---
import { Aside, FileTree, Tabs, TabItem, } from '@astrojs/starlight/components';


Dans le cadre du développement d'applications Odoo, les **champs calculés**, 
ainsi que les décorateurs `@api.depends` et `@api.onchange` améliorent l'expérience utilisateur. 
Ces mécanismes permettent d'automatiser des actions, de recalculer des valeurs dynamiques 
et de réagir à des interactions dans l'interface utilisateur, sans nécessiter de lourdes interventions manuelles. 

Le but des exercices ci-dessous est de comprendre le fonctionnement de ces outils, mais sachez que
toutes les informations sur la syntaxe de ces champs est disponible en ligne : 
- [champs calculés et le décorateur api.depends](https://www.odoo.com/documentation/19.0/developer/reference/backend/orm.html#computed-fields)
- [le décorateur api.onchange](https://www.odoo.com/documentation/19.0/developer/reference/backend/orm.html#odoo.api.onchange)

## Champs calculés et @api.depends

Un champ calculé est un champ dont la valeur n’est pas saisie directement par l’utilisateur, 
mais déduite automatiquement à partir d’autres champs du modèle.
Autrement dit, sa valeur est calculée dynamiquement chaque fois qu’elle est nécessaire, 
plutôt que stockée en base de données.

Ces champs sont particulièrement utiles pour effectuer des calculs ou des traitements automatiques,
par exemple lorsqu’une valeur doit être mise à jour dès qu’un autre champ change.

Imaginons un modèle `Person` qui contient un champ `date_of_birth`.

```python
date_of_birth = fields.Date(string="Date de naissance")
```

On souhaite ajouter un champ calculé `age` qui détermine l’âge actuel 
de la personne à partir de sa date de naissance.

```python
age = fields.Integer(string="Âge",compute='_compute_age')
```

La valeur de ce champs est calculé par la méthode '_compute_age'
qui a la structure suivante : 

```python
def _compute_age(self):
    today = date.today()
    for person in self:
        if person.date_of_birth:
            birth_date = person.date_of_birth
            person.age = today.year - birth_date.year - (
                (today.month, today.day) < (birth_date.month, birth_date.day)
            )
        else:
            person.age = 0
```

La méthode `_compute_age` doit se déclencher dès que la date de naissance est modifiée,
ce qui s'implémente via le décorateur `@api.depends('date_of_birth')`.

```python ins={1}
@api.depends('date_of_birth')
def _compute_age(self):
    today = date.today()
    for person in self:
        if person.date_of_birth:
            birth_date = person.date_of_birth
            person.age = today.year - birth_date.year - (
                (today.month, today.day) < (birth_date.month, birth_date.day)
            )
        else:
            person.age = 0
```

Ainsi, chaque fois qu’on modifie la date de naissance, Odoo recalcule automatiquement 
la valeur du champ `age`.

**Un champ calculé n'est pas stocké en base de données**

<Aside icon="magnifier" title="Exercice">

Créez un champ `task_count` dans le modèle `todo.task.tag` qui compte le nombre de tâches associées à chaque tag.

Le champ `task_count` doit être recalculé automatiquement chaque fois que les tâches associées au tag sont modifiées.

Utilisez le décorateur `@api.depends` pour que ce champ se mette à jour dès qu'une tâche est ajoutée ou supprimée de la relation `Many2many`.

</Aside>

Le décorateur `@api.depends` peut être vu comme une implémentation de l'observateur-observé avec
les champs placés comme paramètre de api.depends() comme Observés et les champs calculés comme Observateurs.

## `@api.onchange`

Le décorateur `@api.onchange` permet de déclencher automatiquement une fonction 
dès que l’utilisateur modifie un champ dans le formulaire.

Contrairement à `@api.depends`, qui est utilisé pour recalculer des champs en fonction 
des changements apportés dans la base de données, `@api.onchange` s’exécute avant 
toute écriture en base de données, ce qui le rend très rapide.

Il est idéal pour valider des saisies en temps réel, pré-remplir d’autres champs ou afficher des messages ou avertissements immédiats
avant que l’utilisateur ne sauvegarde l’enregistrement.


Imaginons un modèle `SaleOrder` avec un champ `order_date` et un champ `delivery_date`.

```python
order_date = fields.Date(string="Date de commande")
delivery_date = fields.Date(string="Date de livraison")
```

Pour s’assurer que la date de livraison est postérieure à la date de commande, 
on peut définir une méthode `_onchange_delivery_date` qui affichera un message 
d’avertissement en cas d’incohérence.
En ajoutant le décorateur `@api.onchange('delivery_date')`, la méthode est 
automatiquement déclenchée dès que le champ `delivery_date` est modifié dans le formulaire.

```python
@api.onchange('delivery_date')
def _onchange_delivery_date(self):
    if self.delivery_date and self.order_date:
        if self.delivery_date < self.order_date:
            return {
                'warning': {
                    'title': "Date invalide",
                    'message': "La date de livraison ne peut pas être antérieure à la date de commande."
                }
            }
```

<Aside icon="magnifier" title="Exercice">

Modifier la classe `TodoTask` du sous-module `todo_stage` pour que lors de la mise à jour 
d'une tâche si le responsable est modifié :
- La relation avec les membres de l'équipe soit effacée.
- Le message d'alerte suivant soit affiché : `Please choose a new Team`.

</Aside>